{
  "info": {
    "name": "Exam API - Automated Tests",
    "_postman_id": "e7f1c8b1-0000-4000-8000-000000000000",
    "description": "Collection to test exam join/submit/leaderboard endpoints. Set collection variables before running: baseUrl, token, examId.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3001"
    },
    {
      "key": "token",
      "value": ""
    },
    {
      "key": "examId",
      "value": ""
    },
    {
      "key": "participationId",
      "value": ""
    },
    {
      "key": "totalScore",
      "value": ""
    }
  ],
  "item": [
    {
      "name": "1 - Join Exam",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"password\": \"secret\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/exams/{{examId}}/join",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "exams",
            "{{examId}}",
            "join"
          ]
        }
      },
      "response": [],
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Join returns 2xx', function () { pm.response.to.have.status(200); });",
              "if (res && res.participationId) { pm.collectionVariables.set('participationId', res.participationId); pm.test('participationId set', () => pm.expect(res.participationId).to.be.a('string')); } else { pm.test('participationId present', () => false); }"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "2 - Submit Exam",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"participationId\": \"{{participationId}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/exams/{{examId}}/submit",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "exams",
            "{{examId}}",
            "submit"
          ]
        }
      },
      "response": [],
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const pid = pm.collectionVariables.get('participationId');",
              "if (!pid) {",
              "  console.log('No participationId found - performing join automatically');",
              "  pm.sendRequest({",
              "    url: pm.variables.get('baseUrl') + '/api/exams/' + pm.variables.get('examId') + '/join',",
              "    method: 'POST',",
              "    header: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + pm.variables.get('token') },",
              "    body: { mode: 'raw', raw: JSON.stringify({ password: 'secret' }) }",
              "  }, function (err, res) {",
              "    if (err) { console.error(err); return; }",
              "    try {",
              "      const json = res.json();",
              "      if (json && json.participationId) {",
              "        pm.collectionVariables.set('participationId', json.participationId);",
              "        console.log('Set participationId from auto-join:', json.participationId);",
              "      }",
              "    } catch (e) { console.error('Failed parsing join response', e); }",
              "  });",
              "}"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Submit returns 2xx', function () { pm.response.to.have.status(200); });",
              "if (res && typeof res.totalScore !== 'undefined') { pm.collectionVariables.set('totalScore', String(res.totalScore)); pm.test('totalScore set', () => pm.expect(res.totalScore).to.be.a('number')); } else { pm.test('totalScore present', () => false); }"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "3 - Get Leaderboard",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/exams/{{examId}}/leaderboard?limit=20",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "exams",
            "{{examId}}",
            "leaderboard"
          ],
          "query": [
            {
              "key": "limit",
              "value": "20"
            }
          ]
        }
      },
      "response": [],
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Leaderboard returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Leaderboard is array', () => pm.expect(Array.isArray(res)).to.be.true);",
              "// Optionally assert that our participant appears with expected score if totalScore was set",
              "const expected = pm.collectionVariables.get('totalScore');",
              "if (expected) {",
              "  pm.test('At least one entry has matching score', () => pm.expect(res.some(r => String(r.totalScore) === expected)).to.be.true);",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ]
    }
  ]
}
